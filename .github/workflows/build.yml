name: Build Quotio

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Run with debug logging'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: macos-14  # macOS Sonoma on Apple Silicon

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug - list files
        run: |
          echo "=== Working directory ==="
          pwd
          echo ""
          echo "=== Root files ==="
          ls -la
          echo ""
          echo "=== Xcode project ==="
          ls -la Quotio.xcodeproj/ || echo "Xcode project not found!"
          echo ""
          echo "=== Quotio directory ==="
          ls -la Quotio/ | head -20

      - name: Set up Homebrew
        run: |
          which brew || /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo "brew installed"

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: |
          # Normalize line endings for project.yml
          sed -i '' 's/\r$//' project.yml 2>/dev/null || true
          xcodegen generate

      - name: Verify project generation
        run: |
          echo "=== After XcodeGen ==="
          ls -la Quotio.xcodeproj/
          head -5 Quotio.xcodeproj/project.pbxproj

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Build Quotio
        run: |
          # Xcode project is in root directory, not in Quotio/ subdirectory
          xcodebuild -project Quotio.xcodeproj \
            -scheme Quotio \
            -configuration Release \
            -destination "platform=macOS" \
            build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_ENTITLEMENTS="" \
            2>&1 | tee build.log | grep -E "(Build|error:|warning:|\*\*)" || true

      - name: Find built app
        id: find-app
        run: |
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "Quotio.app" -type d | head -1)
          echo "Found: $APP_PATH"
          echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT

      - name: Create DMG
        run: |
          APP_PATH="${{ steps.find-app.outputs.app_path }}"
          VERSION=$(git describe --tags --abbrev=0 HEAD 2>/dev/null || echo "0.0.0")
          DMG_NAME="Quotio-v${VERSION}"
          
          # Create DMG
          create-dmg \
            --volname "$DMG_NAME" \
            --volicon "Quotio/Assets.xcassets/AppIcon.appiconset/AppIcon.icns" \
            --window-pos 200 200 \
            --window-size 800 600 \
            --app-drop-link 600 185 \
            "${DMG_NAME}.dmg" \
            "$APP_PATH"
          
          echo "Created: ${DMG_NAME}.dmg"
          ls -lh *.dmg

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: Quotio-dmg
          path: Quotio-v*.dmg
          retention-days: 7

      - name: Upload app as ZIP
        uses: actions/upload-artifact@v4
        with:
          name: Quotio-app
          path: ${{ steps.find-app.outputs.app_path }}
          retention-days: 7

  summary:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "## âœ… Build Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your Quotio build with new features is ready!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âœ¨ New Features" >> $GITHUB_STEP_SUMMARY
            echo "- **Smart Model Selection**: Prioritizes PRO accounts with high refresh frequency" >> $GITHUB_STEP_SUMMARY
            echo "- **Usage Tracking**: Per-model analytics with beautiful charts" >> $GITHUB_STEP_SUMMARY
            echo "- **Time-series Visualization**: Hour/Day/Week/Month trends" >> $GITHUB_STEP_SUMMARY
            echo "- **Provider Breakdown**: Visual usage distribution" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to **Actions** tab" >> $GITHUB_STEP_SUMMARY
            echo "2. Select this workflow run" >> $GITHUB_STEP_SUMMARY
            echo "3. Download **Quotio-dmg** or **Quotio-app** artifact" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ Installation" >> $GITHUB_STEP_SUMMARY
            echo "- **DMG**: Open and drag Quotio.app to /Applications/" >> $GITHUB_STEP_SUMMARY
            echo "- **ZIP**: Unzip and move Quotio.app to /Applications/" >> $GITHUB_STEP_SUMMARY
            echo "- First time: Control-click â†’ Open" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the build logs for errors." >> $GITHUB_STEP_SUMMARY
          fi
